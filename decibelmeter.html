<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>分貝計</title>
  <style>
    body {
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>分貝計</h1>
  <button id="startStopButton">開始</button>
  <h2 id="decibelDisplay">0 分貝</h2>

  <script>
    // 取得音訊流
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const microphone = audioContext.createMediaStreamSource(stream);

        // 連接音訊流到分析器
        microphone.connect(analyser);

        // 分析器參數設定
        analyser.fftSize = 2048;
        let dataArray = new Uint8Array(analyser.fftSize);

        // 開始/停止按鈕事件處理函式
        let isRecording = false;
        const startStopButton = document.getElementById('startStopButton');
        startStopButton.addEventListener('click', function() {
          if (!isRecording) {
            isRecording = true;
            audioContext.resume();
            startStopButton.textContent = '停止';
            updateDecibel();
          } else {
            isRecording = false;
            audioContext.suspend();
            startStopButton.textContent = '開始';
          }
        });

        // 更新分貝數顯示函式
        function updateDecibel() {
          if (isRecording) {
            requestAnimationFrame(updateDecibel);
          }
          analyser.getByteFrequencyData(dataArray);
          const average = getAverageDecibel(dataArray);
          document.getElementById('decibelDisplay').textContent = average.toFixed(2) + ' 分貝';
        }

        // 計算平均分貝數函式
        function getAverageDecibel(dataArray) {
          let values = 0;
          const length = dataArray.length;
          for (let i = 0; i < length; i++) {
            values += dataArray[i];
          }
          const average = values / length;
          const decibel = 20 * Math.log10(average / 128);

          if (isNaN(decibel) || decibel === -Infinity) {
            return 0;
          }

          return decibel;
        }
      })
      .catch(function(err) {
        console.error('無法取得音訊流：', err);
      });
  </script>
</body>
</html>